import discord
from discord import guild
from discord import embeds
from discord.ext.commands.core import command
from discord.ext import commands
from discord.ext.commands import Bot
import os
import asyncio
from pymongo import MongoClient



class admin(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.cluster = MongoClient("mongodb+srv://Fenek7645:9YjL0BCyoUyZqiOA@cluster0.aujkm.mongodb.net/warns?retryWrites=true&w=majority")
        self.collusers = self.cluster.warns.collusers
        self.collservers = self.cluster.warns.collserver





    @commands.command(aliases=['Ğ²Ğ°Ñ€Ğ½', 'Ğ’Ğ°Ñ€Ğ½'])
    @commands.has_role(858728730822311947)
    async def warn(self, ctx, member: discord.Member, *, reason='ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾'):
        if self.collusers.find_one({'_id': member.id, 'guild_id': ctx.guild.id})['warns'] >= 3:
            self.collusers.update_one(
                {
                    'id': member.id,
                    'guild_id': ctx.guild.id
                },
                {
                    '$set': {
                        'warns': 0,
                        'reasons': []
                    }
                }
            )

            role = discord.utils.get(ctx.guild.roles, id=858714716012806144)
            await member.add_roles(role)
        else:
            self.collservers.update_one(
                {
                    '_id':ctx.guild.id
                },
                {
                    '$inc': {
                        'case': 1
                    }
                }
            )
            self.collusers.update_one(
                {
                    '_id': member.id,
                    'guild_id': ctx.guild.id
                },
                {
                    '$inc':{
                        'warns': 1
                    },
                    '$push':{
                        'reasons': {
                            'author_id': ctx.author.id,
                            'case': self.collservers.find_one({'id': ctx.guild.id})['case'],
                            'reason': reason
                        }
                    }
                }
            )
        embed_odj = discord.Embed(description=f'â—ï¸{ctx.author} Ğ²Ñ‹Ğ´Ğ°Ğ» Ğ²Ğ°Ñ€Ğ½ {member}â—ï¸ | Ğ°Ğ¹Ğ´Ğ¸ Ğ²Ğ°Ñ€Ğ½Ğ°: {self.collservers.find_one({"_id": ctx.guild.id})["case"]}', color=0x6495ed)
        await ctx.send(embed=embed_odj)

    @commands.command(aliases=['Ñ€ĞµĞ²Ğ°Ñ€Ğ½', 'Ğ ĞµĞ²Ğ°Ñ€Ğ½'])
    @commands.has_role(858728730822311947)
    async def rewarn(self, ctx, case: int):
        if self.collusers.count_documents({'reasons.case': case, 'guild_id': ctx.guild.id}) == 0:
            embed_odj = discord.Embed(description='ğŸ’¿ Ğ¢Ğ°ĞºĞ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ğ½Ğ° Ğ½ĞµÑ‚ ğŸ’¿')
            await ctx.send(embed=embed_odj)
            
        else:
            self.collusers.update_one(
                {
                    'reasons.case': case,
                    'guild_id': ctx.guild.id
                },
                {
                    '$inc':{
                        'warns:' -1
                    },
                    "pull": {
                        'reasons': {
                            'case': case
                        }
                    }
                }
            )
            embed_odj = discord.Embed(description=f'âœ… Ğ’Ğ°Ñ€Ğ½ ÑĞ½ÑÑ‚ âœ…')
            await ctx.send(embed=embed_odj)

    @commands.command(aliases=['Warninfo', 'warnino'])
    async def Ğ²Ğ°Ñ€Ğ½Ğ¸Ğ½Ñ„Ğ¾(self, ctx , member: discord.Member=None):
        usr = self.collusers.find_one({"_id": ctx.author.id, 'guild_id': ctx.guild.id})
        if member is not None:
            usr = self.collusers.find_one({'_id': member.id, "guild.id": ctx.guild.id})
        embed = discord.Embed(title='âš”ï¸ Warns âš”ï¸', color=0x6495ed)
        for value in usr['reasons']:
            embed.add_field(name=f'ğŸ›¡ ĞĞ´Ğ¼Ğ¸Ğ½ ğŸ›¡: {self.bot.get_user(value["author_id"])}',value=f"ğŸ“‹ ĞĞ¾Ğ¼ĞµÑ€ Ğ²Ğ°Ñ€Ğ½Ğ° ğŸ“‹ {value['case']} \n âš–ï¸ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° âš–ï¸ {value['reason']}", inline=False)
        await ctx.send(embed=embed)

        
    
def setup(bot):
    bot.add_cog(admin(bot))
    print('[Cog] admin Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½!')